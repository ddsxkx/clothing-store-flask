{% extends "base.html" %}

{% block title %}–ú–æ–∏ –∑–∞–∫–∞–∑—ã - Elegance Boutique{% endblock %}

{% block content %}
<div class="orders-hero">
    <div class="container">
        <h1 class="page-title">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h1>
        <p class="page-subtitle">–ò—Å—Ç–æ—Ä–∏—è –≤–∞—à–∏—Ö –ø–æ–∫—É–ø–æ–∫ –∏ —Ç–µ–∫—É—â–∏–µ –∑–∞–∫–∞–∑—ã</p>
    </div>
</div>

<div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash-message {{ category }}">
                    <i class="icon-info"></i>
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if orders %}
  <div class="orders-stats">
    <div class="stat-card">
        <div class="stat-icon">üì¶</div>
        <div class="stat-info">
            <span class="stat-number">{{ orders|length }}</span>
            <span class="stat-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <div class="stat-info">
            <span class="stat-number">
                <!-- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—É–º–º—ã -->
                {% set total_sum = namespace(value=0) %}
                {% for order in orders %}
                    {% set total_sum.value = total_sum.value + order.total %}
                {% endfor %}
                {{ total_sum.value|int }}‚ÇΩ
            </span>
            <span class="stat-label">–û–±—â–∞—è —Å—É–º–º–∞</span>
        </div>
    </div>
</div>

    <div class="orders-timeline">
        {% for order in orders %}
        <div class="order-timeline-card">
            <div class="timeline-marker">
                <div class="marker-dot"></div>
                {% if not loop.last %}
                <div class="timeline-line"></div>
                {% endif %}
            </div>

            <div class="order-card">
                <div class="order-header">
                    <div class="order-meta">
                        <div class="order-number">–ó–∞–∫–∞–∑ #{{ order.number }}</div>
                        <div class="order-date">{{ order.date.strftime('%d %B %Y –≤ %H:%M') }}</div>
                    </div>
                    <div class="order-status status-{{ order.status|lower }}">
                        <span class="status-dot"></span>
                        {{ order.status }}
                    </div>
                </div>

                <div class="order-content">
                    <div class="order-details">
                        <div class="detail-item">
                            <i class="icon-location"></i>
                            <div class="detail-content">
                                <span class="detail-label">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</span>
                                <span class="detail-value">{{ order.address }}</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="icon-wallet"></i>
                            <div class="detail-content">
                                <span class="detail-label">–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞</span>
                                <span class="detail-value price">{{ order.total }} ‚ÇΩ</span>
                            </div>
                        </div>

                        <!-- –ë–õ–û–ö –° –¢–û–í–ê–†–ê–ú–ò –ó–ê–ö–ê–ó–ê -->
                        <div class="order-items-preview">
                            <h4>–¢–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑–µ:</h4>
                            <div class="items-preview-list">
                                {% if order.order_items %}
                                    <!-- –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ order_items –Ω–µ –ø—É—Å—Ç–æ–π -->
                                    {% if order.order_items|length > 0 %}
                                        {% for item in order.order_items[:3] %} <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 3 —Ç–æ–≤–∞—Ä–∞ -->
                                        <div class="preview-item">
                                            <span class="item-name">{{ item[0] }}</span>
                                            <span class="item-quantity">√ó{{ item[1] }}</span>
                                            <span class="item-price">{{ item[3] }} ‚ÇΩ</span>
                                        </div>
                                        {% endfor %}
                                        {% if order.order_items|length > 3 %}
                                        <div class="more-items">
                                            <em>... –∏ –µ—â–µ {{ order.order_items|length - 3 }} —Ç–æ–≤–∞—Ä–æ–≤</em>
                                        </div>
                                        {% endif %}
                                    {% else %}
                                        <div class="no-items">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                                    {% endif %}
                                {% else %}
                                    <div class="no-items">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="order-actions">
                        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª–Ω–æ–≥–æ —Å–æ—Å—Ç–∞–≤–∞ –∑–∞–∫–∞–∑–∞ -->
                        {% if order.order_items and order.order_items|length > 0 %}
                        <button class="btn btn-outline view-items-btn" data-order-id="{{ order.id }}">
                            <i class="icon-list"></i>
                            –í–µ—Å—å —Å–æ—Å—Ç–∞–≤
                        </button>
                        {% endif %}

                        {% if order.status == '—Å–æ–∑–¥–∞–Ω' %}
                        <a href="{{ url_for('payment', order_id=order.id) }}" class="btn btn-primary">
                            <i class="icon-card"></i>
                            –û–ø–ª–∞—Ç–∏—Ç—å —Å–µ–π—á–∞—Å
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">üõçÔ∏è</div>
        <h2>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</h2>
        <p>–ù–∞—á–Ω–∏—Ç–µ shopping-–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –¥–ª—è —Å–µ–±—è –º–∏—Ä –º–æ–¥—ã</p>
        <a href="{{ url_for('catalog') }}" class="btn btn-primary btn-large">
            <i class="icon-bag"></i>
            –ù–∞—á–∞—Ç—å –ø–æ–∫—É–ø–∫–∏
        </a>
    </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–æ—Å—Ç–∞–≤–∞ –∑–∞–∫–∞–∑–∞ -->
<div id="orderItemsModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3 id="modalTitle">–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞</h3>
        <div id="orderItemsList"></div>
    </div>
</div>

<script>
// JavaScript –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
document.querySelectorAll('.view-items-btn').forEach(button => {
    button.addEventListener('click', function() {
        const orderId = this.getAttribute('data-order-id');
        loadOrderItems(orderId);
    });
});

function loadOrderItems(orderId) {
    const list = document.getElementById('orderItemsList');
    list.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

    document.getElementById('orderItemsModal').style.display = 'block';

    fetch(`/api/order/${orderId}/items`)
        .then(response => response.json())
        .then(data => {
            let html = '<div class="order-items-list">';

            if (data.items && data.items.length > 0) {
                data.items.forEach(item => {
                    html += `
                    <div class="order-item-row">
                        <div class="item-image">
                            <img src="${item.image || '/static/images/placeholder.jpg'}"
                                 alt="${item.name}"
                                 onerror="this.src='/static/images/placeholder.jpg'">
                        </div>
                        <div class="item-info">
                            <h4>${item.name}</h4>
                            <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${item.quantity}</p>
                            <p>–¶–µ–Ω–∞: ${item.price} ‚ÇΩ</p>
                            <p class="item-total">–°—É–º–º–∞: ${item.total} ‚ÇΩ</p>
                        </div>
                    </div>`;
                });

                html += `
                <div class="order-total-summary">
                    <hr>
                    <div class="total-row">
                        <strong>–ò—Ç–æ–≥–æ:</strong>
                        <strong>${data.total} ‚ÇΩ</strong>
                    </div>
                </div>`;
            } else {
                html += '<div class="empty-items">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            }

            html += '</div>';
            list.innerHTML = html;
            document.getElementById('modalTitle').textContent = `–ó–∞–∫–∞–∑ #${data.order_number}`;
        })
        .catch(error => {
            list.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö</div>';
        });
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
document.querySelector('.close').addEventListener('click', function() {
    document.getElementById('orderItemsModal').style.display = 'none';
});

window.addEventListener('click', function(event) {
    const modal = document.getElementById('orderItemsModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
});
</script>
{% endblock %}